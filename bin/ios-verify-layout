#!/usr/bin/env bash
# Verify current Home Screen layout summary via cfgutil get-icon-layout
# Usage: bin/ios-verify-layout [--udid <UDID>]

set -euo pipefail

UDID="${IOS_DEVICE_UDID:-}"
DEVICE_LABEL=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --udid|-u)
      UDID="$2"; shift 2 ;;
    --device-label)
      DEVICE_LABEL="$2"; shift 2 ;;
    -h|--help)
      echo "Usage: $0 [--udid <UDID>] [--device-label <label>]"; exit 0 ;;
    *)
      echo "Unknown arg: $1" >&2; exit 1 ;;
  esac
done

CFGUTIL="cfgutil"
if ! command -v cfgutil >/dev/null 2>&1; then
  if [[ -x "/Applications/Apple Configurator.app/Contents/MacOS/cfgutil" ]]; then
    CFGUTIL="/Applications/Apple Configurator.app/Contents/MacOS/cfgutil"
  else
    echo "Error: cfgutil not found" >&2
    exit 127
  fi
fi

args=()
if [[ -n "$DEVICE_LABEL" ]]; then
  # try to map label -> udid from credentials.ini
  ini_get() {
    local file="$1" section="$2" key="$3"
    awk -v s="$section" -v k="$key" '
      BEGIN{i=0}
      $0 ~ /^[[:space:]]*\[/ { i = ($0 ~ "^\\s*\\[" s "\\]\\s*$") ? 1 : 0 }
      i==1 && $0 ~ "^[[:space:]]*" k "[[:space:]]*=" {
        val=$0; sub(/^[^=]*=/, "", val); gsub(/^[ \t]+|[ \t]+$/, "", val); print val; exit 0
      }
    ' "$file"
  }
  for c in "${CREDENTIALS:-}" \
           "${XDG_CONFIG_HOME:-$HOME/.config}/credentials.ini" \
           "$HOME/.config/credentials.ini" \
           "${XDG_CONFIG_HOME:-$HOME/.config}/sre-utils/credentials.ini" \
           "$HOME/.config/sre-utils/credentials.ini" \
           "$HOME/.config/sreutils/credentials.ini" \
           "$HOME/.sre-utils/credentials.ini"; do
    if [[ -f "$c" ]]; then
      ud="$(ini_get "$c" ios_devices "$DEVICE_LABEL" || true)"
      if [[ -n "$ud" ]]; then UDID="$ud"; break; fi
    fi
  done
fi

if [[ -n "$UDID" ]]; then
  # map UDID to ECID
  ECID="$("$CFGUTIL" list 2>/dev/null | awk -v U="$UDID" 'index($0,"UDID:")&&index($0,U){for(i=1;i<=NF;i++){if($i=="ECID:"){print $(i+1); exit}}}')"
  if [[ -n "$ECID" ]]; then
    args+=(--ecid "$ECID")
  fi
fi

echo "Layout (cfgutil get-icon-layout):"
"$CFGUTIL" "${args[@]}" get-icon-layout
