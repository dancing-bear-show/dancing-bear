#!/usr/bin/env bash
# Set up an iOS device mapping and write settings.init for easy reuse
#
# - Updates/creates [ios_devices] in credentials.ini with <label>=<UDID>
# - Writes ~/.config/settings.init (or XDG_CONFIG_HOME) exporting IOS_DEVICE_LABEL, IOS_DEVICE_UDID, IOS_CREDS_PROFILE
# - Can auto-detect UDID from cfgutil when --detect is provided
#
# Usage:
#   bin/ios-setup-device \
#     --label <name> \
#     [--udid <UDID> | --detect] \
#     [--creds-profile ios_layout_manager] \
#     [--config /path/credentials.ini]

set -euo pipefail

LABEL=""
UDID="${IOS_DEVICE_UDID:-}"
CREDS_PROFILE="${IOS_CREDS_PROFILE:-ios_layout_manager}"
CONFIG_PATH=""
DETECT=0

usage() {
  cat >&2 <<EOF
Usage: $0 --label <name> [--udid <UDID> | --detect] [--creds-profile <section>] [--config /path/credentials.ini]

Writes ~/.config/settings.init (or XDG_CONFIG_HOME) and maps [ios_devices] <label>=<UDID> in credentials.ini.
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --label) LABEL="$2"; shift 2 ;;
    --udid) UDID="$2"; shift 2 ;;
    --detect) DETECT=1; shift ;;
    --creds-profile) CREDS_PROFILE="$2"; shift 2 ;;
    --config) CONFIG_PATH="$2"; shift 2 ;;
    -h|--help) usage; exit 0 ;;
    *) echo "Unknown arg: $1" >&2; usage; exit 2 ;;
  esac
done

if [[ -z "$LABEL" ]]; then
  echo "Error: --label is required" >&2; usage; exit 2
fi

# Resolve cfgutil path (optional, only used for detection hint)
CFGUTIL_BIN="cfgutil"
if ! command -v cfgutil >/dev/null 2>&1; then
  if [[ -x "/Applications/Apple Configurator.app/Contents/MacOS/cfgutil" ]]; then
    CFGUTIL_BIN="/Applications/Apple Configurator.app/Contents/MacOS/cfgutil"
  elif [[ -x "/Applications/Apple Configurator 2.app/Contents/MacOS/cfgutil" ]]; then
    CFGUTIL_BIN="/Applications/Apple Configurator 2.app/Contents/MacOS/cfgutil"
  fi
fi

if [[ $DETECT -eq 1 && -z "$UDID" ]]; then
  if [[ ! -x "$CFGUTIL_BIN" ]]; then
    echo "Error: --detect requested but cfgutil not found; install Apple Configurator or pass --udid." >&2
    exit 127
  fi
  # Take the first attached device UDID
  UDID="$("$CFGUTIL_BIN" list 2>/dev/null | awk '/UDID:[[:space:]]*/{sub(/.*UDID:[[:space:]]*/,""); split($0,a,/[ \t]/); print a[1]; exit}')"
  if [[ -z "$UDID" ]]; then
    echo "Error: no attached device found via cfgutil; connect a device or pass --udid." >&2
    exit 1
  fi
fi

if [[ -z "$UDID" ]]; then
  echo "Error: --udid missing (or use --detect)." >&2
  exit 2
fi

# Resolve credentials.ini path
resolve_config() {
  if [[ -n "$CONFIG_PATH" && -f "$CONFIG_PATH" ]]; then echo "$CONFIG_PATH"; return 0; fi
  if [[ -n "${CREDENTIALS:-}" && -f "${CREDENTIALS}" ]]; then echo "${CREDENTIALS}"; return 0; fi
  local xdg=${XDG_CONFIG_HOME:-"$HOME/.config"}
  local p="$xdg/credentials.ini"
  if [[ -f "$p" ]]; then echo "$p"; return 0; fi
  p="$HOME/.config/credentials.ini"
  if [[ -f "$p" ]]; then echo "$p"; return 0; fi
  p="$xdg/sre-utils/credentials.ini"
  if [[ -f "$p" ]]; then echo "$p"; return 0; fi
  p="$HOME/.config/sre-utils/credentials.ini"
  if [[ -f "$p" ]]; then echo "$p"; return 0; fi
  p="$HOME/.config/sreutils/credentials.ini"
  if [[ -f "$p" ]]; then echo "$p"; return 0; fi
  p="$HOME/.sre-utils/credentials.ini"
  if [[ -f "$p" ]]; then echo "$p"; return 0; fi
  # Default new path
  echo "$xdg/credentials.ini"
}

CFG_FILE=$(resolve_config)
mkdir -p "$(dirname "$CFG_FILE")"
if [[ ! -f "$CFG_FILE" ]]; then
  echo "# Autogenerated credentials (created by ios-setup-device)" > "$CFG_FILE"
fi

# Update [ios_devices] mapping
tmpfile="$(mktemp -t iossetup.XXXXXX)"; trap 'rm -f "$tmpfile"' EXIT
awk -v lbl="$LABEL" -v val="$UDID" '
  BEGIN{found=0; insec=0}
  {
    if ($0 ~ /^[[:space:]]*\[/) {
      if (insec==1 && found==0) { print lbl " = " val; found=1 }
      insec= ($0 ~ /^\s*\[ios_devices\]\s*$/) ? 1 : 0
    }
    if (insec==1 && $0 ~ "^[[:space:]]*" lbl "[[:space:]]*=") {
      if (found==0) { print lbl " = " val; found=1 }
      next
    }
    print $0
  }
  END{
    if (insec==1 && found==0) { print lbl " = " val; found=1 }
    if (found==0) {
      print ""
      print "[ios_devices]"
      print lbl " = " val
    }
  }
' "$CFG_FILE" > "$tmpfile"
mv "$tmpfile" "$CFG_FILE"

# Write settings.init under XDG config
CONFIG_ROOT="${XDG_CONFIG_HOME:-$HOME/.config}"
SETTINGS_FILE="$CONFIG_ROOT/settings.init"
mkdir -p "$CONFIG_ROOT"
{
  echo "# Autogenerated by bin/ios-setup-device"
  echo "export IOS_DEVICE_LABEL=\"$LABEL\""
  echo "export IOS_DEVICE_UDID=\"$UDID\""
  echo "export IOS_CREDS_PROFILE=\"$CREDS_PROFILE\""
  # Detect cfgutil bundle and add to PATH if not present
  if ! command -v cfgutil >/dev/null 2>&1 && [[ -x "/Applications/Apple Configurator.app/Contents/MacOS/cfgutil" ]]; then
    echo "export PATH=\"/Applications/Apple Configurator.app/Contents/MacOS:\$PATH\""
  fi
} > "$SETTINGS_FILE"

echo "Mapped device label '$LABEL' â†’ UDID $UDID in $CFG_FILE"
echo "Wrote $SETTINGS_FILE (source this file to set environment variables)."
