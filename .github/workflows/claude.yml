name: Claude Code

on:
  # Auto-review on PR open only
  pull_request:
    types: [opened]
  # Also respond to @claude mentions
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  # Auto-review new PRs
  auto-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Auto Review PR
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Review this PR following the guidelines in .github/CLAUDE_REVIEW.md

            Key priorities:
            1. Security issues (credentials, injection, path traversal)
            2. Bugs and logic errors
            3. Breaking changes to CLI or public APIs
            4. Missing tests for new functionality
            5. Project patterns (lazy imports, pipeline pattern, dry-run support)

            Output format:
            - Start with 1-2 sentence summary
            - Group issues by severity: ðŸ”´ Blocking, ðŸŸ¡ Suggestions, ðŸŸ¢ Nice to Have
            - Include file:line references and concrete fix suggestions
            - Be concise â€” only comment if there are actionable issues

            Skip: style nitpicks, import ordering, files in out/, .venv/, backups/

  # Respond to @claude mentions
  respond:
    if: |
      github.event_name != 'pull_request' &&
      contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Respond to Mention
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
