#!/usr/bin/env bash
# Switch the active iOS device by label and rewrite settings.init under ~/.config

set -euo pipefail

LABEL=""
CONFIG_PATH=""
CREDS_PROFILE="${IOS_CREDS_PROFILE:-ios_layout_manager}"

usage(){
  echo "Usage: $0 --label <name> [--config /path/credentials.ini] [--creds-profile <section>]" >&2
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --label) LABEL="$2"; shift 2 ;;
    --config) CONFIG_PATH="$2"; shift 2 ;;
    --creds-profile) CREDS_PROFILE="$2"; shift 2 ;;
    -h|--help) usage; exit 0 ;;
    *) echo "Unknown arg: $1" >&2; usage; exit 2 ;;
  esac
done

if [[ -z "$LABEL" ]]; then
  echo "Error: --label is required" >&2; usage; exit 2
fi

resolve_config(){
  if [[ -n "$CONFIG_PATH" && -f "$CONFIG_PATH" ]]; then echo "$CONFIG_PATH"; return 0; fi
  if [[ -n "${CREDENTIALS:-}" && -f "${CREDENTIALS}" ]]; then echo "${CREDENTIALS}"; return 0; fi
  local xdg=${XDG_CONFIG_HOME:-"$HOME/.config"}
  local p="$xdg/credentials.ini"
  if [[ -f "$p" ]]; then echo "$p"; return 0; fi
  p="$HOME/.config/credentials.ini"
  if [[ -f "$p" ]]; then echo "$p"; return 0; fi
  p="$xdg/sre-utils/credentials.ini"
  if [[ -f "$p" ]]; then echo "$p"; return 0; fi
  p="$HOME/.config/sre-utils/credentials.ini"
  if [[ -f "$p" ]]; then echo "$p"; return 0; fi
  p="$HOME/.config/sreutils/credentials.ini"
  if [[ -f "$p" ]]; then echo "$p"; return 0; fi
  p="$HOME/.sre-utils/credentials.ini"
  if [[ -f "$p" ]]; then echo "$p"; return 0; fi
  echo ""; return 1
}

CFG_FILE=$(resolve_config)
if [[ -z "$CFG_FILE" ]]; then
  echo "Error: credentials.ini not found; pass --config or create ~/.config/credentials.ini" >&2
  exit 1
fi

# Extract UDID for label
UDID=$(awk -v k="$LABEL" '
  BEGIN{i=0}
  $0 ~ /^[[:space:]]*\[/ {i = ($0 ~ /^\s*\[ios_devices\]\s*$/) ? 1 : 0}
  i==1 && $0 ~ "^[[:space:]]*" k "[[:space:]]*=" {val=$0; sub(/^[^=]*=/, "", val); gsub(/^[ \t]+|[ \t]+$/, "", val); print val; exit 0}
' "$CFG_FILE")

if [[ -z "$UDID" ]]; then
  echo "Error: label '$LABEL' not found in [ios_devices] of $CFG_FILE" >&2
  exit 2
fi

CONFIG_ROOT="${XDG_CONFIG_HOME:-$HOME/.config}"
SETTINGS_FILE="$CONFIG_ROOT/settings.init"
mkdir -p "$CONFIG_ROOT"
{
  echo "# Autogenerated by bin/ios-use-device"
  echo "export IOS_DEVICE_LABEL=\"$LABEL\""
  echo "export IOS_DEVICE_UDID=\"$UDID\""
  echo "export IOS_CREDS_PROFILE=\"$CREDS_PROFILE\""
  if ! command -v cfgutil >/dev/null 2>&1 && [[ -x "/Applications/Apple Configurator.app/Contents/MacOS/cfgutil" ]]; then
    echo "export PATH=\"/Applications/Apple Configurator.app/Contents/MacOS:\$PATH\""
  fi
} > "$SETTINGS_FILE"

echo "Switched active device to '$LABEL' (UDID $UDID). Wrote $SETTINGS_FILE"
