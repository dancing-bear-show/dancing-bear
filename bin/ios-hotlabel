#!/usr/bin/env bash
# Hot-label an iOS device UDID and generate environment.init
#
# Writes/updates the [ios_devices] section in credentials.ini and writes
# ./environment.init exporting IOS_DEVICE_LABEL and IOS_DEVICE_UDID.
#
# Usage:
#   bin/ios-hotlabel --label <name> --udid <UDID> [--config /path/credentials.ini]

set -euo pipefail

LABEL=""
UDID="${IOS_DEVICE_UDID:-}"
CONFIG_PATH=""

usage() {
  echo "Usage: $0 --label <name> --udid <UDID> [--config /path/credentials.ini]" >&2
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --label) LABEL="$2"; shift 2 ;;
    --udid) UDID="$2"; shift 2 ;;
    --config) CONFIG_PATH="$2"; shift 2 ;;
    -h|--help) usage; exit 0 ;;
    *) echo "Unknown arg: $1" >&2; usage; exit 2 ;;
  esac
done

if [[ -z "$LABEL" || -z "$UDID" ]]; then
  echo "Error: --label and --udid are required" >&2
  usage
  exit 2
fi

# Resolve credentials.ini path
resolve_config() {
  if [[ -n "$CONFIG_PATH" && -f "$CONFIG_PATH" ]]; then echo "$CONFIG_PATH"; return 0; fi
  if [[ -n "${CREDENTIALS:-}" && -f "${CREDENTIALS}" ]]; then echo "${CREDENTIALS}"; return 0; fi
  local xdg=${XDG_CONFIG_HOME:-"$HOME/.config"}
  local p="$xdg/credentials.ini"
  if [[ -f "$p" ]]; then echo "$p"; return 0; fi
  p="$HOME/.config/credentials.ini"
  if [[ -f "$p" ]]; then echo "$p"; return 0; fi
  p="$xdg/sre-utils/credentials.ini"
  if [[ -f "$p" ]]; then echo "$p"; return 0; fi
  p="$HOME/.config/sre-utils/credentials.ini"
  if [[ -f "$p" ]]; then echo "$p"; return 0; fi
  p="$HOME/.config/sreutils/credentials.ini"
  if [[ -f "$p" ]]; then echo "$p"; return 0; fi
  p="$HOME/.sre-utils/credentials.ini"
  if [[ -f "$p" ]]; then echo "$p"; return 0; fi
  # Default new path
  echo "$xdg/credentials.ini"
}

CFG_FILE=$(resolve_config)
mkdir -p "$(dirname "$CFG_FILE")"

# Ensure [ios_devices] section exists and set/overwrite the label
if [[ ! -f "$CFG_FILE" ]]; then
  echo "# Autogenerated credentials (create by ios-hotlabel)" > "$CFG_FILE"
fi

tmp="$(mktemp -t ioslabel.XXXXXX)"
trap 'rm -f "$tmp"' EXIT

awk -v lbl="$LABEL" -v val="$UDID" '
  BEGIN{found=0; insec=0}
  {
    if ($0 ~ /^[[:space:]]*\[/) {
      if (insec==1 && found==0) {
        print lbl " = " val
        found=1
      }
      insec= ($0 ~ /^\s*\[ios_devices\]\s*$/) ? 1 : 0
    }
    if (insec==1 && $0 ~ "^[[:space:]]*" lbl "[[:space:]]*=") {
      if (found==0) { print lbl " = " val; found=1 }
      next
    }
    print $0
  }
  END{
    if (insec==1 && found==0) { print lbl " = " val; found=1 }
    if (found==0) {
      print ""
      print "[ios_devices]"
      print lbl " = " val
    }
  }
' "$CFG_FILE" > "$tmp"
mv "$tmp" "$CFG_FILE"

# Write environment.init in repo root
ROOT_DIR="$(CDPATH= cd -- "$(dirname -- "$0")" && cd .. && pwd)"
ENV_FILE="$ROOT_DIR/environment.init"
cat > "$ENV_FILE" <<EOF
# Autogenerated by bin/ios-hotlabel
export IOS_DEVICE_LABEL="$LABEL"
export IOS_DEVICE_UDID="$UDID"
# Default creds profile used by ios-pages-sync and ios-install-profile
export IOS_CREDS_PROFILE="ios_layout_manager"
EOF

echo "Labeled UDID $UDID as '$LABEL' in $CFG_FILE"
echo "Wrote $ENV_FILE exporting IOS_DEVICE_LABEL and IOS_DEVICE_UDID"
